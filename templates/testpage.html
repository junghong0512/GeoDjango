<!DOCTYPE html>
<html>
{% load static %}
{% load leaflet_tags %}
<head>
    {% leaflet_js %}
    {% leaflet_css %}
    <title>Our Home</title>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
    </style>
    <link rel="stylesheet" type="text/css" href="{% static 'routing/leaflet-routing-machine.css' %}"></link>
    <link rel="stylesheet" type="text/css" href="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.css' %}"></link>
    <script type="text/javascript" src="{% static 'dist/leaflet.ajax.js' %}"></script>
    <script type="text/javascript" src="{% static 'routing/leaflet-routing-machine.js' %}"></script>
    <script type="text/javascript" src="{% static 'leaflet-groupedlayercontrol/leaflet.groupedlayercontrol.js' %}"></script>

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <div id='map'></div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoianVuZ2hvbmciLCJhIjoiY2twbnBiZTA3MXQ3NjJ2bHJodHJmN2oyYSJ9.QW798Vk3hHy6I158OoHDzg';
        var map = new mapboxgl.Map({
            container: 'map', // container ID
            style: 'mapbox://styles/junghong/ckqitbyxt078b17mq4y5hykva', // style URL
            //style: 'mapbox://styles/mapbox/streets-v10', // style URL
            center: [126.643855, 37.383911], // starting position [lng, lat]
            // center: [-87.61694, 41.86625], // starting position [lng, lat]
            zoom: 15.23, // starting zoom
            bearing: -17.6,
            antialias: true,
        });

        const r = 255 * 0.65;
        map.on('style.load', function() {
            map.addLayer({
                'id': '3d-buildings',
                'source': 'composite',
                //'source': {
                //    'type': 'vector',
                //    'url': 'mapbox://mapbox.3d-buildings'
                //},
                'source-layer': 'building',
                'filter': ['==', 'extrude', 'true'],
                'type': 'fill-extrusion',
                'minzoom': 15,
                'paint': {
                    'fill-extrusion-color': ['rgb', ['number', ['feature-state', 'hover-r'], r], ['number', ['feature-state', 'hover-g'], r], ['number', ['feature-state', 'hover-b'], r]],
                    'fill-extrusion-height': ["get", "height"],
                    'fill-extrusion-opacity': 0.6

                }
            });

            map.addSource('mapbox-dem', {
                "type": "raster-dem",
                "url": "mapbox://mapbox.mapbox-terrain-dem-v1",
                "tileSize": 512,
                "maxzoom": 14
            });
            map.setTerrain({"source": "mapbox-dem"});

            let hovered = [];
            window.addEventListener('mousemove', function(e) {
                e.point = new mapboxgl.Point(e.clientX, e.clientY);
                console.time('query');
                const features = map.queryRenderedFeatures(e.point, {layers: ['3d-buildings']});
                console.timeEnd('query');

                for (const feature of hovered) {
                    map.setFeatureState(feature, {
                        'hover-r': r,
                        'hover-g': r,
                        'hover-b': r
                    });
                }

                const seen = {};
                hovered = features;
                let i = 0;
                for (const feature of hovered) {
                    if (seen[feature.id]) continue;

                    seen[feature.id] = true;
                    map.setFeatureState(feature, {
                        'hover-r': i === 0 ? 255 : r,
                        'hover-g': i === 1 ? 255 : r,
                        'hover-b': i >= 2 ? 255 : r
                    });
                    i++;
                }
            });
        });

    </script>


</body>
</html>